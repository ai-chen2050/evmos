# Hetu Checkpointing

The Hetu Checkpointing module is responsible for maintaining snapshots generated by the Hetu chain and interacting with the [Hetu Checkpoints network](https://github.com/hetu-project/hetu-checkpoint). The Hetu Checkpoints network is a scalable validation network that supports a large number of validators, utilizing EigenLayer AVS for staking or restaking. It employs BLS signatures for aggregating signatures to reduce on-chain data and provide cryptographic security.

The technical core of the Checkpointing module is the [BLS signature](https://en.wikipedia.org/wiki/BLS_digital_signature) scheme, around which this module provides the following functionalities:

- making checkpoints and signing, verifying, then 
- broadcast ckpt to the dispatcher of the checkpoints validation network,
- dispatcher will dispatch ckpt and aggregating BLS signatures from validators, then
- the dispatcher submits the results of BLS aggregated signatures to the Checkpointing module,
- constructing checkpoints out of the BLS signatures, and
- maintaining the status of the checkpoints.

## States

The Checkpointing module maintains the following KV stores.

### Checkpoint

The [checkpoint state](./keeper/ckpt_state.go) maintains all the checkpoints. 
The key is the epoch number and the value is a `RawCheckpointWithMeta`
[object](../../proto/hetu/checkpointing/v1/checkpoint.proto) representing a
raw checkpoint along with some metadata.

```protobuf
// RawCheckpoint wraps the BLS multi sig with metadata
message RawCheckpoint {
  option (gogoproto.equal) = true;

  // epoch_num defines the epoch number the raw checkpoint is for
  uint64 epoch_num = 1;
  // block_hash defines the 'BlockID.Hash', which is the hash of
  // the latest block
  bytes block_hash = 2 [ (gogoproto.customtype) = "BlockHash" ];
  // bitmap defines the bitmap that indicates the signers of the BLS multi sig
  bytes bitmap = 3;
  // bls_multi_sig defines the multi sig that is aggregated from individual BLS
  // sigs
  bytes bls_multi_sig = 4
      [ (gogoproto.customtype) =
            "github.com/hetu-project/hetu/v1/crypto/bls12381.Signature" ];
}

// RawCheckpointWithMeta wraps the raw checkpoint with metadata.
message RawCheckpointWithMeta {
  option (gogoproto.equal) = true;

  RawCheckpoint ckpt = 1;
  // status defines the status of the checkpoint
  CheckpointStatus status = 2;
  // bls_aggr_pk defines the aggregated BLS public key
  bytes bls_aggr_pk = 3
      [ (gogoproto.customtype) =
            "github.com/hetu-project/hetu/v1/crypto/bls12381.PublicKey" ];
  // power_sum defines the accumulated voting power for the checkpoint
  uint64 power_sum = 4;
  // lifecycle defines the lifecycle of this checkpoint, i.e., each state
  // transition and the time (in both timestamp and block height) of this
  // transition.
  repeated CheckpointStateUpdate lifecycle = 5;
}
```

## Messages

The request message type is defined at
[proto/hetu/checkpointing/v1/tx.proto](../../proto/hetu/checkpointing/v1/tx.proto).
The message handler is defined at
[x/checkpointing/keeper/msg_server.go](./keeper/msg_server.go).

## Queries

The Checkpointing module provides a set of queries the status of
checkpoints, listed at
[query.proto](../../proto/hetu/checkpointing/v1/query.proto).
